// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. Tenants (Đơn vị thuê/sử dụng hệ thống)
model Tenant {
  id        String    @id @default(uuid())
  name      String
  createdAt DateTime  @default(now()) @map("created_at")

  products   Product[]
  affiliates Affiliate[]

  @@map("tenants")
}

// 2. Products (Sản phẩm/App được tích hợp)
model Product {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  name            String
  slug            String   @unique
  domain          String
  apiKey          String   @unique @map("api_key") // Secret key riêng cho từng app
  commissionType  String   @map("commission_type") // 'percentage' | 'fixed'
  commissionValue Float    @map("commission_value")
  cookieDuration  Int      @default(30) @map("cookie_duration") // days
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")

  tenant      Tenant       @relation(fields: [tenantId], references: [id])
  clicks      Click[]
  conversions Conversion[]

  @@map("products")
}

// 3. Affiliates (Cộng tác viên)
model Affiliate {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  userId      String?  @map("user_id") // Optional link to external user system
  email       String
  code        String   @unique // Referral Code (e.g., USER001)
  balance     Float    @default(0)
  paymentInfo String?  @map("payment_info") // JSON or text details
  status      String   @default("active") // 'active', 'suspended'
  createdAt   DateTime @default(now()) @map("created_at")

  tenant      Tenant       @relation(fields: [tenantId], references: [id])
  clicks      Click[]
  conversions Conversion[]
  payouts     Payout[]

  @@map("affiliates")
}

// 4. Clicks (Lượt truy cập)
model Click {
  id          String   @id @default(uuid())
  productId   String   @map("product_id")
  affiliateId String   @map("affiliate_id")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")

  product   Product   @relation(fields: [productId], references: [id])
  affiliate Affiliate @relation(fields: [affiliateId], references: [id])

  @@map("clicks")
}

// 5. Conversions (Đơn hàng thành công)
model Conversion {
  id               String   @id @default(uuid())
  productId        String   @map("product_id")
  affiliateId      String   @map("affiliate_id")
  orderId          String   @map("order_id") // Order ID from external system
  orderAmount      Float    @map("order_amount")
  commissionAmount Float    @map("commission_amount")
  status           String   @default("pending") // 'pending', 'approved', 'rejected', 'paid'
  createdAt        DateTime @default(now()) @map("created_at")

  product   Product   @relation(fields: [productId], references: [id])
  affiliate Affiliate @relation(fields: [affiliateId], references: [id])

  @@unique([orderId, productId]) // orderId unique per product (multi-app safe)
  @@map("conversions")
}

// 6. Payouts (Yêu cầu rút tiền)
model Payout {
  id          String   @id @default(uuid())
  affiliateId String   @map("affiliate_id")
  amount      Float
  status      String   @default("requested") // 'requested', 'paid', 'rejected'
  createdAt   DateTime @default(now()) @map("created_at")
  processedAt DateTime? @map("processed_at")

  affiliate Affiliate @relation(fields: [affiliateId], references: [id])

  @@map("payouts")
}
